<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Cuencas - Ancash</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Helvetica, Arial, sans-serif; display: flex; height: 100vh; }
        
        #sidebar {
            width: 320px; background-color: #f8f9fa; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000;
            overflow-y: auto;
        }

        #map { flex-grow: 1; height: 100%; }

        h2 { margin-top: 0; color: #2c3e50; font-size: 1.2rem; }
        .control-group { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 8px; }
        select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        .info-box { margin-top: auto; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 0.9rem; color: #0d47a1; }
    </style>

    <script>
        window.requestIdleCallback = window.requestIdleCallback || function(cb) {
            var start = Date.now();
            return setTimeout(function() { cb({ didTimeout: false, timeRemaining: function() { return Math.max(0, 50 - (Date.now() - start)); } }); }, 1);
        };
        window.cancelIdleCallback = window.cancelIdleCallback || function(id) { clearTimeout(id); };
    </script>
</head>
<body>

    <div id="sidebar">
        <h2>Panel de Control</h2>

        <div class="control-group">
            <label> Seleccionar Cuenca:</label>
            <select id="selectorCuenca" onchange="actualizarMapaCuencas()">
                <option value="todas">-- Ver Todas --</option>
            </select>
        </div>

        <div class="control-group">
            <label> Filtrar Puntos:</label>
            <select id="filtroTipo" onchange="pintarPuntos()">
                <option value="todos">Cargando...</option>
            </select>
        </div>
        
        <div class="control-group">
             <label> Unidad Hidrogr谩fica:</label>
            <select id="filtroCuenca" onchange="pintarPuntos()">
                <option value="todos">Todas</option>
            </select>
        </div>

        <div class="info-box">
            <div id="datosCuenca">Selecciona una cuenca para ver sus detalles.</div>
            <br>
            <small>Puntos visibles: <span id="contadorPuntos">0</span></small>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <script>
        // --- 1. CONFIGURACIN ---
        
        // PEGA AQU TU ENLACE CSV
        const urlCSV = "PEGAR_AQUI_TU_ENLACE_CSV"; 
        
        const archivoGeoJSON = "cuencas.geojson"; 

        // Variables Globales
        var columnaNombreDetectada = null; 
        var datosGeoJSON_Cache = null; // Guardaremos los datos crudos aqu铆

        var map = L.map('map').setView([-9.5, -77.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '漏 OpenStreetMap' }).addTo(map);

        var layerCuencas = L.geoJSON(null).addTo(map);
        var layerPuntos = L.layerGroup().addTo(map);
        var datosPuntos = [];

        proj4.defs("EPSG:32717","+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs");

        // --- CARGAR DATOS ---

        // 1. Cargar GeoJSON (MODO ROBUSTO + VISUALIZACIN EXCLUSIVA)
        fetch(archivoGeoJSON)
            .then(res => {
                if (!res.ok) throw new Error("Error HTTP al cargar GeoJSON: " + res.status);
                return res.json();
            })
            .then(data => {
                // 1. Guardar copia de seguridad de los datos crudos
                datosGeoJSON_Cache = data; 
                
                // 2. DETECTIVE DE COLUMNAS (Miramos el archivo crudo, no el mapa)
                let propiedadesEncontradas = null;
                
                // Verificamos si es una colecci贸n de features
                if (data.features && data.features.length > 0) {
                     propiedadesEncontradas = data.features[0].properties;
                } else if (data.properties) {
                    // Caso raro: es una sola feature suelta
                    propiedadesEncontradas = data.properties;
                    // Lo convertimos a array para que el resto del c贸digo funcione
                    datosGeoJSON_Cache = { features: [data], type: "FeatureCollection" };
                }

                if (propiedadesEncontradas) {
                    let llaves = Object.keys(propiedadesEncontradas);
                    
                    // Buscar columna de nombre autom谩ticamente
                    columnaNombreDetectada = llaves.find(k => k.toLowerCase().includes("nom") || k.toLowerCase().includes("name") || k.toLowerCase().includes("uh"));
                    
                    if (!columnaNombreDetectada) columnaNombreDetectada = llaves[0]; // Plan Z
                    
                    console.log("Columna detectada:", columnaNombreDetectada);
                    
                    // 3. Llenar el selector
                    llenarSelectorCuencas(datosGeoJSON_Cache);
                    
                    // 4. Dibujar mapa inicial (Todas)
                    actualizarMapaCuencas();

                } else {
                    console.warn("El GeoJSON carg贸 pero no tiene propiedades/columnas legibles.");
                    alert("Alerta: Tu mapa se carg贸 pero no tiene datos (nombres) asociados.");
                }
            })
            .catch(err => {
                console.error("Error Grave GeoJSON:", err);
                alert("Error cargando el mapa de cuencas. Revisa la consola.");
            });

        // 2. Cargar CSV
        Papa.parse(urlCSV, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                datosPuntos = results.data;
                llenarSelectoresPuntos();
                pintarPuntos();
            },
            error: function(err) { console.error("Error CSV:", err); }
        });

        // --- FUNCIONES LGICAS NUEVAS ---

        function llenarSelectorCuencas(data) {
            let sel = document.getElementById('selectorCuenca');
            let nombres = new Set(); 

            // Extraemos nombres directamente del JSON crudo
            data.features.forEach(f => {
                if (f.properties && columnaNombreDetectada) {
                    let n = f.properties[columnaNombreDetectada];
                    if (n) nombres.add(n);
                }
            });

            let listaOrdenada = Array.from(nombres).sort();
            
            listaOrdenada.forEach(n => {
                let opt = document.createElement('option');
                opt.value = n;
                opt.innerText = n;
                sel.appendChild(opt);
            });
        }

        // FUNCIN DE FILTRO EXCLUSIVO (BORRA Y DIBUJA)
        function actualizarMapaCuencas() {
            let seleccion = document.getElementById('selectorCuenca').value;
            
            // 1. Borramos todo el mapa de cuencas actual
            layerCuencas.clearLayers();

            if (!datosGeoJSON_Cache) return;

            let datosA_Mostrar = null;

            // 2. Filtramos los datos crudos
            if (seleccion === "todas") {
                datosA_Mostrar = datosGeoJSON_Cache;
            } else {
                // Crear un mini-geojson solo con la cuenca elegida
                let featuresFiltrados = datosGeoJSON_Cache.features.filter(f => 
                    f.properties[columnaNombreDetectada] == seleccion
                );
                datosA_Mostrar = {
                    type: "FeatureCollection",
                    features: featuresFiltrados
                };
            }

            // 3. Dibujamos solo lo necesario
            layerCuencas.addData(datosA_Mostrar);

            // 4. Aplicamos Estilos
            if (seleccion === "todas") {
                layerCuencas.setStyle({ color: "#555", weight: 1, fillOpacity: 0.1, fillColor: "blue" });
                document.getElementById('datosCuenca').innerHTML = "Visualizando todas las cuencas.";
            } else {
                // Estilo destacado
                layerCuencas.setStyle({ color: "#d32f2f", weight: 3, fillOpacity: 0.4, fillColor: "#ffCDD2" });
                
                // Zoom
                if (layerCuencas.getBounds().isValid()) {
                    map.fitBounds(layerCuencas.getBounds());
                }
                
                // Mostrar Info
                if(datosA_Mostrar.features.length > 0) {
                    mostrarInfoPanel(datosA_Mostrar.features[0]);
                }
            }

            // 5. Reactivar Popups
            layerCuencas.eachLayer(layer => {
                if (layer.feature && layer.feature.properties) {
                    let n = layer.feature.properties[columnaNombreDetectada] || "Sin Nombre";
                    layer.bindPopup(`<b>${n}</b>`);
                }
            });
        }
        
        function mostrarInfoPanel(feature) {
             if(feature && feature.properties) {
                let nombre = feature.properties[columnaNombreDetectada];
                let infoHtml = `<b>${nombre}</b><hr>`;
                for (const [key, value] of Object.entries(feature.properties)) {
                    if(key !== "geometry") { 
                        infoHtml += `<div style="font-size:11px;"><b>${key}:</b> ${value}</div>`;
                    }
                }
                document.getElementById('datosCuenca').innerHTML = infoHtml;
             }
        }

        // --- FUNCIONES PUNTOS (Igual que antes) ---
        function convertirCoord(este, norte) {
            if (!este || !norte) return null;
            let e = parseFloat(este.toString().replace(',', '.'));
            let n = parseFloat(norte.toString().replace(',', '.'));
            try {
                let p = proj4("EPSG:32717", 'EPSG:4326', [e, n]);
                if (isNaN(p[0])) return null;
                return [p[1], p[0]]; 
            } catch { return null; }
        }

        function pintarPuntos() {
            layerPuntos.clearLayers();
            let filtroTipo = document.getElementById('filtroTipo').value;
            let filtroCuenca = document.getElementById('filtroCuenca').value;
            let contador = 0;
            
            datosPuntos.forEach(d => {
                if (filtroTipo !== 'todos' && d.TIPO_RH !== filtroTipo) return;
                if (filtroCuenca !== 'todos' && d.UNIDAD_HID !== filtroCuenca) return;
                
                let latlng = convertirCoord(d.ESTE, d.NORTE);
                if (latlng) {
                    contador++;
                    let marker = L.circleMarker(latlng, { radius: 6, color: 'white', fillColor: '#e65100', fillOpacity: 0.9, weight: 1 });
                    let contenido = `<b>${d.CODIGO_FI}</b><br>${d.DESCRIPCION}<br><hr style="margin:5px 0;">As (2023): ${d.As_ppm_2023i || '-'}`;
                    marker.bindPopup(contenido);
                    layerPuntos.addLayer(marker);
                }
            });
            document.getElementById('contadorPuntos').innerText = contador;
        }

        function llenarSelectoresPuntos() {
            let selTipo = document.getElementById('filtroTipo');
            let selCuenca = document.getElementById('filtroCuenca');
            let tipos = new Set();
            let cuencas = new Set();
            datosPuntos.forEach(d => {
                if(d.TIPO_RH) tipos.add(d.TIPO_RH);
                if(d.UNIDAD_HID) cuencas.add(d.UNIDAD_HID);
            });
            tipos.forEach(t => { let o=document.createElement('option'); o.value=t; o.innerText=t; selTipo.appendChild(o); });
            cuencas.forEach(c => { let o=document.createElement('option'); o.value=c; o.innerText=c; selCuenca.appendChild(o); });
        }
    </script>
</body>
</html>
