<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Monitoreo Ambiental</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* RESET Y ESTRUCTURA BÁSICA */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* 1. BARRA LATERAL (IZQUIERDA) */
        #sidebar {
            width: 320px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* 2. CONTENEDOR DEL MAPA (DERECHA) */
        #map {
            flex-grow: 1;
            height: 100%;
        }

        /* ESTILOS DEL SIDEBAR */
        h2 { margin-top: 0; color: #2c3e50; font-size: 1.2rem; }
        .control-group { margin-bottom: 20px; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 5px; }
        select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: white; }
        
        .stats {
            margin-top: auto;
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            color: #495057;
        }

        /* ESTILO DEL POPUP */
        .leaflet-popup-content-wrapper { border-radius: 4px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 280px !important; }
        
        .popup-header {
            background-color: #d35400; /* Naranja quemado */
            color: white;
            padding: 10px;
            font-weight: bold;
        }
        .popup-body { padding: 10px; font-size: 12px; }
        
        .tabla-datos { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .tabla-datos td { border-bottom: 1px solid #eee; padding: 4px 0; }
        .tabla-datos td:first-child { color: #666; font-weight: 500; }
        .tabla-datos td:last-child { text-align: right; font-weight: bold; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Panel de Control</h2>
        <p style="font-size: 12px; color: #666;">Visualización de puntos en Zona 17S.</p>

        <div class="control-group">
            <label>Tipo de Fuente:</label>
            <select id="filtroTipo" onchange="aplicarFiltros()">
                <option value="todos">Cargando datos...</option>
            </select>
        </div>

        <div class="control-group">
            <label>Unidad Hidrográfica:</label>
            <select id="filtroCuenca" onchange="aplicarFiltros()">
                <option value="todos">Todas</option>
            </select>
        </div>

        <div class="stats">
            <strong>Resumen:</strong><br>
            Puntos visibles: <span id="numPuntos">0</span>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <script>
        // --- 1. PEGA TU ENLACE AQUÍ ---
        const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZoRkV36w1tJ_wWvgMIuUda7PHYPLYGo3eRFkbym7UdARNyL8nw4JIphGplupwiipyxBFvLlpU6Mtb/pub?gid=0&single=true&output=csv";

        // Configuración inicial del mapa
        var map = L.map('map').setView([-9.5, -77.5], 6);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        var layerGroup = L.layerGroup().addTo(map);
        var datos = [];

        // DEFINICIÓN FIJA: ZONA 17 SUR (EPSG:32717)
        // Ya no adivinamos la zona, usamos esta fórmula matemática fija.
        const UTM_ZONE_17S = "+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs";
        proj4.defs("EPSG:32717", UTM_ZONE_17S);

        // Cargar datos
        Papa.parse(urlCSV, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                datos = results.data;
                llenarSelectores();
                pintarPuntos();
            }
        });

        // --- FUNCIÓN COORDENADAS (SOLO ZONA 17S) ---
        function convertirCoordenadas(este, norte) {
            if (!este || !norte) return null;

            // Limpieza de números (Cambiar coma por punto si existe)
            let e = parseFloat(este.toString().replace(',', '.'));
            let n = parseFloat(norte.toString().replace(',', '.'));
            
            try {
                // Convertimos SIEMPRE usando Zona 17 Sur
                let p = proj4("EPSG:32717", 'EPSG:4326', [e, n]);
                
                // Validar que no sea un error matemático
                if (isNaN(p[0]) || isNaN(p[1])) return null;
                
                // Retorna [Lat, Lon]
                return [p[1], p[0]]; 
            } catch (error) {
                return null;
            }
        }

        function pintarPuntos() {
            layerGroup.clearLayers();
            let tipoSel = document.getElementById('filtroTipo').value;
            let cuencaSel = document.getElementById('filtroCuenca').value;
            let contador = 0;
            
            // Variable para calcular el Auto-Zoom
