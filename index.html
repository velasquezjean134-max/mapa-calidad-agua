<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Cuencas - Ancash</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; }
        
        /* Panel Lateral */
        #sidebar {
            width: 300px; background-color: #f8f9fa; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000;
        }

        /* Mapa */
        #map { flex-grow: 1; height: 100%; }

        h2 { margin-top: 0; color: #2c3e50; font-size: 1.2rem; }
        .control-group { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 8px; }
        select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        .info-box { margin-top: auto; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 0.9rem; color: #0d47a1; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Panel de Control</h2>

        <div class="control-group">
            <label>游깱 Seleccionar Cuenca:</label>
            <select id="selectorCuenca" onchange="resaltarCuenca()">
                <option value="">-- Ver Todo --</option>
            </select>
        </div>

        <div class="control-group">
            <label>游늸 Filtrar Puntos de Monitoreo:</label>
            <select id="filtroTipo" onchange="pintarPuntos()">
                <option value="todos">Cargando puntos...</option>
            </select>
        </div>

        <div class="info-box">
            <div id="datosCuenca">Selecciona una cuenca para ver sus detalles.</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <script>
        // --- 1. TUS ARCHIVOS ---
        // Pega aqu칤 tu enlace CSV de los PUNTOS (Google Sheets)
        const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZoRkV36w1tJ_wWvgMIuUda7PHYPLYGo3eRFkbym7UdARNyL8nw4JIphGplupwiipyxBFvLlpU6Mtb/pub?gid=0&single=true&output=csv"; 
        
        // Aseg칰rate de que el archivo del mapa se llame AS칈 en GitHub:
        const archivoGeoJSON = "cuencas.geojson"; 

        // Configuraci칩n del Mapa
        var map = L.map('map').setView([-9.5, -77.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '춸 OpenStreetMap' }).addTo(map);

        var layerCuencas = L.geoJSON(null).addTo(map);
        var layerPuntos = L.layerGroup().addTo(map);
        
        var datosGeoJSON = null;
        var datosPuntos = [];

        // Definir proyecci칩n UTM 17S (Per칰)
        proj4.defs("EPSG:32717","+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs");

        // --- CARGAR DATOS ---

        // 1. Cargar Mapa de Cuencas (GeoJSON)
        fetch(archivoGeoJSON)
            .then(res => res.json())
            .then(data => {
                datosGeoJSON = data;
                // Configurar estilo base
                layerCuencas = L.geoJSON(data, {
                    style: { color: "#555", weight: 1, fillOpacity: 0.1 },
                    onEachFeature: function(feature, layer) {
                        // AQU칈 USAMOS TUS COLUMNAS DEL CSV (NOMBRE, CODIGO, AREA)
                        let nombre = feature.properties.NOMBRE || "Cuenca";
                        let area = feature.properties.AREA_KM2 || 0;
                        let codigo = feature.properties.CODIGO || "-";
                        
                        layer.bindPopup(`<b>${nombre}</b><br>C칩digo: ${codigo}<br>츼rea: ${area} km`);
                    }
                }).addTo(map);
                
                llenarSelectorCuencas();
            })
            .catch(err => console.error("Error cargando cuencas.geojson:", err));

        // 2. Cargar Puntos (CSV Google Sheets)
        Papa.parse(urlCSV, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                datosPuntos = results.data;
                llenarSelectorPuntos();
                pintarPuntos();
            }
        });

        // --- FUNCIONES ---

        function resaltarCuenca() {
            let seleccion = document.getElementById('selectorCuenca').value;
            
            layerCuencas.eachLayer(layer => {
                let props = layer.feature.properties;
                // Restaurar estilo original
                layer.setStyle({ color: "#555", weight: 1, fillOpacity: 0.1, fillColor: "blue" });
                
                if (seleccion === props.NOMBRE) {
                    // Resaltar selecci칩n
                    layer.setStyle({ color: "#d32f2f", weight: 3, fillOpacity: 0.4, fillColor: "#ffCDD2" });
                    layer.openPopup();
                    map.fitBounds(layer.getBounds());
                    
                    // Mostrar datos en el panel
                    document.getElementById('datosCuenca').innerHTML = 
                        `<b>${props.NOMBRE}</b><br>
                         츼rea: ${props.AREA_KM2} km<br>
                         C칩digo ANA: ${props.CODIGO}`;
                }
            });
        }

        function llenarSelectorCuencas() {
            let sel = document.getElementById('selectorCuenca');
            if (!datosGeoJSON) return;
            
            // Ordenar alfab칠ticamente
            let nombres = datosGeoJSON.features.map(f => f.properties.NOMBRE).sort();
            
            nombres.forEach(n => {
                let opt = document.createElement('option');
                opt.value = n;
                opt.innerText = n;
                sel.appendChild(opt);
            });
        }

        // Funci칩n auxiliar para convertir coordenadas
        function convertirCoord(este, norte) {
            if (!este || !norte) return null;
            let e = parseFloat(este.toString().replace(',', '.'));
            let n = parseFloat(norte.toString().replace(',', '.'));
            try {
                let p = proj4("EPSG:32717", 'EPSG:4326', [e, n]);
                if (isNaN(p[0])) return null;
                return [p[1], p[0]]; 
            } catch { return null; }
        }

        function pintarPuntos() {
            layerPuntos.clearLayers();
            let filtro = document.getElementById('filtroTipo').value;
            
            datosPuntos.forEach(d => {
                if (filtro !== 'todos' && d.TIPO_RH !== filtro) return;
                
                let latlng = convertirCoord(d.ESTE, d.NORTE);
                if (latlng) {
                    let marker = L.circleMarker(latlng, { radius: 6, color: 'white', fillColor: '#0277bd', fillOpacity: 1, weight: 1 });
                    marker.bindPopup(`<b>${d.CODIGO_FI}</b><br>${d.DESCRIPCION}`);
                    layerPuntos.addLayer(marker);
                }
            });
        }

        function llenarSelectorPuntos() {
            let sel = document.getElementById('filtroTipo');
            let tipos = [...new Set(datosPuntos.map(d => d.TIPO_RH))].filter(Boolean);
            tipos.forEach(t => {
                let opt = document.createElement('option');
                opt.value = t; opt.innerText = t;
                sel.appendChild(opt);
            });
        }
    </script>
</body>
</html>
